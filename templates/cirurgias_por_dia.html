{% extends "base.html" %}
{% block title %}Cirurgias do Dia{% endblock %}

{% block content %}
<style>
  .navegacao-seta {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    font-size: 2rem;
    width: 50px;
    height: 50px;
    background-color: #fff;
    border: 1px solid #ccc;
    border-radius: 6px;
    cursor: pointer;
    z-index: 10;
  }
  .navegacao-seta:hover {
    background-color: #f0f0f0;
  }
  .navegacao-esquerda { left: 10px; }
  .navegacao-direita { right: 10px; }
</style>

<!-- Botões Laterais -->
<div class="navegacao-seta navegacao-esquerda text-center" onclick="navegar(-1)">&#x276E;</div>
<div class="navegacao-seta navegacao-direita text-center" onclick="navegar(1)">&#x276F;</div>

<!-- Botão de Nova Cirurgia -->
<div class="text-center mb-4">
  <a href="{{ url_for('cadastrar_cirurgia') }}" class="btn btn-outline-primary">+ Nova Cirurgia</a>
</div>

<!-- Conteúdo Central -->
<div class="mx-auto bg-white p-4 rounded shadow-sm" style="max-width: 800px;">
  <h5 class="text-center fw-semibold mb-4" id="paciente-nome">Nome Paciente</h5>

  <form>
    <div class="mb-3">
      <label class="form-label">Prontuário</label>
      <input type="text" class="form-control" id="ficha-prontuario" disabled>
    </div>

    <div class="mb-3">
      <label class="form-label">Comorbidades</label>
      <textarea class="form-control" id="ficha-comorbidades" rows="2" disabled></textarea>
    </div>

    <div class="mb-3">
      <label class="form-label">Anticoagulante</label>
      <input type="text" class="form-control" id="ficha-anticoagulante" disabled>
    </div>

    <div class="mb-3">
      <label class="form-label">Materiais</label>
      <input type="text" class="form-control" id="ficha-materiais" disabled>
    </div>

    <div class="mb-3">
      <label class="form-label">Outros Materiais</label>
      <input type="text" class="form-control" id="ficha-outros" disabled>
    </div>

    <div class="mb-3">
      <label class="form-label">Horário</label>
      <input type="text" class="form-control" id="ficha-horario" disabled>
    </div>

    <div class="mb-3">
      <label class="form-label">Observações</label>
      <textarea class="form-control" id="ficha-observacoes" rows="3" disabled></textarea>
    </div>

    <div class="mb-3">
      <label class="form-label">Status</label><br>
      <span class="badge px-3 py-2 rounded-pill text-white" id="ficha-status">---</span>
    </div>

    <div class="mb-3">
      <h6 class="fw-semibold">Exames</h6>
      <div id="exames" class="d-flex flex-wrap gap-2"></div>
    </div>

    <div class="text-end mt-4">
      <button type="button" class="btn btn-success me-2" id="btn-realizar">Marcar como Realizada</button>
      <button type="button" class="btn btn-danger" id="btn-cancelar">Cancelar Agendamento</button>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
let cirurgias = [];
let atual = 0;

function exibirFicha(c) {
  document.getElementById("paciente-nome").innerText = c.nome;
  document.getElementById("ficha-prontuario").value = c.prontuario;
  document.getElementById("ficha-comorbidades").value = c.comorbidades || '---';
  document.getElementById("ficha-anticoagulante").value = c.anticoagulante || '---';
  document.getElementById("ficha-materiais").value = c.materiais || '---';
  document.getElementById("ficha-outros").value = c.outros_materiais || '---';
  document.getElementById("ficha-horario").value = c.horario || '---';
  document.getElementById("ficha-observacoes").value = c.observacoes || '---';

  const statusSpan = document.getElementById("ficha-status");
  statusSpan.innerText = c.status;
  statusSpan.className = 'badge px-3 py-2 rounded-pill text-white ' + (
    {
      agendada: 'bg-primary',
      realizada: 'bg-success',
      cancelada: 'bg-danger'
    }[c.status] || 'bg-secondary'
  );

  const examesDiv = document.getElementById("exames");
  examesDiv.innerHTML = '';
  if (c.exames && Array.isArray(c.exames)) {
    c.exames.forEach(ex => {
      const img = document.createElement("img");
      img.src = ex.caminho;
      img.alt = ex.descricao || '';
      img.title = ex.descricao || '';
      img.style = "height: 70px; cursor: pointer; border-radius: 6px;";
      img.onclick = () => window.open(ex.caminho, "_blank");
      examesDiv.appendChild(img);
    });
  }
}

document.addEventListener("DOMContentLoaded", () => {
  fetch(`/api/cirurgias_por_data?data={{ data }}`)
    .then(res => res.json())
    .then(json => {
      if (json.length === 0) {
        document.querySelector(".mx-auto").innerHTML =
          "<div class='text-muted text-center'>Nenhuma cirurgia encontrada para este dia.</div>";
        return;
      }

      cirurgias = json.map(c => ({
        ...c,
        data_formatada: "{{ data }}"
      }));

      exibirFicha(cirurgias[0]);
    });

  document.getElementById("btn-cancelar").addEventListener("click", () => {
    const cirurgia = cirurgias[atual];
    if (!cirurgia || !confirm("Tem certeza que deseja cancelar esta cirurgia?")) return;

    fetch(`/api/cirurgia/cancelar`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prontuario: cirurgia.prontuario, data: cirurgia.data_formatada })
    })
    .then(res => res.json())
    .then(resp => {
      alert(resp.mensagem || "Cirurgia cancelada.");
      window.location.reload();
    });
  });

  document.getElementById("btn-realizar").addEventListener("click", () => {
    const cirurgia = cirurgias[atual];
    if (!cirurgia || !confirm("Deseja marcar esta cirurgia como realizada?")) return;

    fetch(`/api/cirurgia/realizar`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prontuario: cirurgia.prontuario, data: cirurgia.data_formatada })
    })
    .then(res => res.json())
    .then(resp => {
      alert(resp.mensagem || "Cirurgia atualizada.");
      window.location.reload();
    });
  });
});
</script>
{% endblock %}
